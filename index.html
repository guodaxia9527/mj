<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éº»å°†ç»“ç®—å™¨-å…¨èƒ½è§„åˆ™ç‰ˆ</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <link rel="apple-touch-icon" href="./icon.svg">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(reg => console.log('PWA æ³¨å†ŒæˆåŠŸ'))
                    .catch(err => console.error('PWA æ³¨å†Œå¤±è´¥', err));
            });
        }
    </script>

    <style>
        :root { --primary: #2c3e50; --win-text: #e74c3c; --lose-text: #27ae60; --bg: #f4f7f6; --zh-color: #c0392b; --wechat: #07c160; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; touch-action: manipulation; box-sizing: border-box; }
        input { -webkit-user-select: auto; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 10px 40px; }
        .container { max-width: 480px; margin: auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 15px; margin-top: 10px; }
        
        .total-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: var(--primary); color: white; padding: 15px 10px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .total-item div:first-child { font-size: 11px; opacity: 0.8; margin-bottom: 5px; overflow: hidden; white-space: nowrap; }
        .total-item div:last-child { font-size: 18px; font-weight: 900; font-family: monospace; }

        .section { margin-bottom: 12px; padding: 12px; border: 1px solid #eee; border-radius: 15px; background: #fff; }
        .section-title { font-size: 13px; color: #7f8c8d; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .section-title span::before { content: ""; display: inline-block; width: 4px; height: 14px; background: var(--primary); margin-right: 8px; border-radius: 2px; vertical-align: middle; }
        
        .fold-arrow { transition: transform 0.3s; font-size: 10px; color: #bdc3c7; }
        .folded .fold-arrow { transform: rotate(-90deg); }
        .folded #name-list-container { display: none; }

        .name-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .name-item { display: flex; align-items: center; background: #f8f9fa; border-radius: 10px; padding: 4px 10px; border: 1px solid #eee; }
        .move-btn { background: #eee; border: none; border-radius: 6px; width: 32px; height: 32px; color: #7f8c8d; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .name-input { flex: 1; border: none; background: transparent; padding: 8px 10px; font-size: 14px; font-weight: bold; color: var(--primary); text-align: center; }
        .name-input:focus { outline: none; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-check { display: none; }
        .btn-label { display: block; padding: 12px 2px; text-align: center; background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.1s; overflow: hidden; white-space: nowrap; }
        .btn-check:checked + .btn-label { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .btn-check:disabled + .btn-label { opacity: 0.2; cursor: not-allowed; background: #f1f1f1; }

        .mqq-box { display: flex; align-items: center; justify-content: center; padding: 12px; background: #fff9db; border-radius: 10px; margin-top: 8px; border: 1px solid #ffe066; font-size: 14px; }
        .qys-box { background: #e3f2fd; border: 1px solid #90caf9; color: #1976d2; }

        .score-card { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; border-radius: 12px; margin-bottom: 5px; border: 1px solid #eee; }
        .win-item { background: #fff5f5; color: var(--win-text); border-color: #ffdada; }
        .lose-item { background: #f0fff4; color: var(--lose-text); border-color: #dcf5e1; }
        .score-val { font-weight: 800; font-size: 20px; font-family: monospace; }
        .dealer-tag { font-size: 10px; background: #f39c12; color: white; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }

        .btn-group { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin: 15px 0; }
        .action-btn { padding: 16px; border: none; border-radius: 15px; background: #27ae60; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(39,174,96,0.3); }
        .zh-btn { background: var(--zh-color); box-shadow: 0 4px 10px rgba(192,57,43,0.3); }

        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 6px; }
        .history-main { display: flex; justify-content: space-between; align-items: center; }
        .history-tag { font-size: 10px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #7f8c8d; }
        .zh-tag { background: var(--zh-color); color: white; }
        .history-detail-bar { font-size: 11px; color: #7f8c8d; background: #f9f9f9; padding: 6px 10px; border-radius: 8px; display: flex; justify-content: space-between; }
        .del-btn { color: #e74c3c; font-size: 18px; padding-left: 10px; cursor: pointer; }

        .title-actions { display: flex; gap: 12px; align-items: center; }
        .action-link { font-size: 11px; font-weight: normal; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="total-panel" id="total-panel"></div>

    <div class="section" id="player-section">
        <div class="section-title" onclick="toggleNames()">
            <span>ğŸ‘¤ ç©å®¶ (ä½¿ç”¨ç®­å¤´è°ƒæ•´åº§ä½)</span>
            <span class="fold-arrow">â–¼</span>
        </div>
        <div id="name-list-container" class="name-grid"></div>
    </div>

    <div class="section">
        <div class="section-title"><span>ğŸ† èµ¢å®¶ (ç‚¸èƒ¡æ—¶é€‰ç‚¸èƒ¡è€…)</span></div>
        <div class="grid" id="winner-grid"></div>
    </div>

    <div class="section">
        <div class="section-title">
            <span>ğŸ  åº„å®¶</span>
            <div style="font-size:11px;color:#3498db" onclick="passDealer()">ä¸‹å®¶ä¸Šåº„ â†»</div>
        </div>
        <div class="grid" id="dealer-grid"></div>
    </div>

    <div class="section">
        <div class="section-title"><span>ğŸ”« ç‚¹ç‚®è€…</span></div>
        <div class="grid" id="loser-grid"></div>
    </div>

    <div class="section">
        <div class="section-title"><span>âš™ï¸ èƒ¡ç‰Œç±»å‹</span></div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:8px;">
            <input type="radio" name="winType" id="t1" value="1" class="btn-check" checked onchange="calculate()"><label for="t1" class="btn-label">å±èƒ¡ (1x)</label>
            <input type="radio" name="winType" id="t2" value="2" class="btn-check" onchange="calculate()"><label for="t2" class="btn-label">è‡ªæ‘¸ (2x)</label>
            <input type="radio" name="winType" id="t3" value="4" class="btn-check" onchange="calculate()"><label for="t3" class="btn-label">æ‚å® (4x)</label>
            <input type="radio" name="winType" id="t4" value="8" class="btn-check" onchange="calculate()"><label for="t4" class="btn-label">å®ä¸­å® (8x)</label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top:8px;">
            <label class="mqq-box"><input type="checkbox" id="mqq" onchange="calculate()">&nbsp;é—¨å‰æ¸… x2</label>
            <label class="mqq-box qys-box"><input type="checkbox" id="qys" onchange="calculate()">&nbsp;æ¸…ä¸€è‰² x2</label>
        </div>
    </div>

    <div id="result"></div>
    
    <div class="btn-group">
        <button class="action-btn" onclick="recordGame(false)">ç¡®è®¤è®°å½•</button>
        <button class="action-btn zh-btn" onclick="recordGame(true)">ç‚¸èƒ¡ç»“ç®—</button>
    </div>

    <div class="section">
        <div class="section-title">
            <span id="history-title-text">ğŸ“œ å†å²å¤ç›˜ (å…±0å±€)</span>
            <div class="title-actions">
                <div class="action-link" style="color:var(--wechat)" onclick="copyReport()">ğŸŸ¢ åˆ†äº«æˆ˜æŠ¥</div>
                <div class="action-link" style="color:#e74c3c" onclick="clearHistory()">æ¸…ç©º</div>
            </div>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>
</div>

<script>
    let players = JSON.parse(localStorage.getItem('mj_p_v7')) || [
        { id: 101, name: "æå¤§å˜´" }, { id: 102, name: "ä¸«è›‹å„¿" }, { id: 103, name: "ç‹å¤§ç™½" }, { id: 104, name: "é”…å¤§ä¾ " }
    ];
    let history = JSON.parse(localStorage.getItem('mj_h_v7')) || [];
    let currentScores = {};

    function save() {
        localStorage.setItem('mj_p_v7', JSON.stringify(players));
        localStorage.setItem('mj_h_v7', JSON.stringify(history));
    }

    function toggleNames() {
        document.getElementById('player-section').classList.toggle('folded');
    }

    function updateUI() {
        renderNameList();
        renderSelection('winner', 'winner-grid');
        renderSelection('dealer', 'dealer-grid');
        updateLoserOptions();
        calculate();
        renderHistory();
        // æ›´æ–°æ€»å¯¹å±€æ•°æ˜¾ç¤º
        document.getElementById('history-title-text').innerText = `ğŸ“œ å†å²å¤ç›˜ (å…±${history.length}å±€)`;
    }

    function renderNameList() {
        const container = document.getElementById('name-list-container');
        container.innerHTML = players.map((p, i) => `
            <div class="name-item">
                <button class="move-btn" onclick="movePlayer(${i}, -1)" ${i === 0 ? 'disabled' : ''}>â–²</button>
                <input type="text" class="name-input" value="${p.name}" oninput="syncNames(${i}, this.value)">
                <button class="move-btn" onclick="movePlayer(${i}, 1)" ${i === 3 ? 'disabled' : ''}>â–¼</button>
            </div>
        `).join('');
    }

    function movePlayer(index, direction) {
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= players.length) return;
        const temp = players[index]; players[index] = players[targetIndex]; players[targetIndex] = temp;
        save(); updateUI();
    }

    function syncNames(index, newName) {
        const pId = players[index].id; players[index].name = newName;
        document.querySelectorAll(`.l-id-${pId}`).forEach(el => el.innerText = newName);
        document.querySelectorAll(`.p-name-id-${pId}`).forEach(el => {
            el.innerHTML = el.querySelector('.dealer-tag') ? `<b>${newName}</b><span class="dealer-tag">åº„</span>` : `<b>${newName}</b>`;
        });
        save(); renderTotals(); calculate();
    }

    function renderSelection(name, containerId) {
        const container = document.getElementById(containerId);
        const currentVal = document.querySelector(`input[name="${name}"]:checked`)?.value || players[0].id;
        container.innerHTML = players.map(p => `
            <input type="radio" name="${name}" id="${name}${p.id}" value="${p.id}" class="btn-check" ${currentVal == p.id ? 'checked' : ''} onchange="refreshLogic('${name}')">
            <label for="${name}${p.id}" class="btn-label l-id-${p.id}">${p.name}</label>
        `).join('');
    }

    function updateLoserOptions() {
        const winnerId = parseInt(document.querySelector('input[name="winner"]:checked')?.value || players[0].id);
        const container = document.getElementById('loser-grid');
        const currentLoser = document.querySelector('input[name="loser"]:checked')?.value || "-1";
        let html = players.filter(p => p.id !== winnerId).map(p => `
            <input type="radio" name="loser" id="l${p.id}" value="${p.id}" class="btn-check" ${currentLoser == p.id ? 'checked' : ''} onchange="calculate()">
            <label for="l${p.id}" class="btn-label l-id-${p.id}">${p.name}</label>
        `).join('');
        html += `<input type="radio" name="loser" id="l-1" value="-1" class="btn-check" ${currentLoser == "-1" ? 'checked' : ''} onchange="calculate()">
                 <label for="l-1" class="btn-label">æ— </label>`;
        container.innerHTML = html;
    }

    function calculate() {
        const winId = parseInt(document.querySelector('input[name="winner"]:checked')?.value || players[0].id);
        const dealId = parseInt(document.querySelector('input[name="dealer"]:checked')?.value || players[0].id);
        const loseId = parseInt(document.querySelector('input[name="loser"]:checked')?.value || -1);
        
        const typeInputs = [document.getElementById('t1'), document.getElementById('t2'), document.getElementById('t3'), document.getElementById('t4')];
        if (loseId !== -1) { document.getElementById('t1').checked = true; typeInputs.slice(1).forEach(i => i.disabled = true); } 
        else { typeInputs.forEach(i => i.disabled = false); }

        const base = parseInt(document.querySelector('input[name="winType"]:checked').value);
        const mqq = document.getElementById('mqq').checked ? 2 : 1;
        const qys = document.getElementById('qys').checked ? 2 : 1;

        let scores = {}; players.forEach(p => scores[p.id] = 0);
        let totalWin = 0;

        players.forEach(p => {
            if (p.id === winId) return;
            let mult = (p.id === dealId || winId === dealId) ? 2 : 1;
            let pay = base * mult * mqq * qys;
            scores[p.id] = -pay;
            totalWin += pay;
        });

        if (loseId !== -1) {
            players.forEach(p => { if(p.id !== winId) scores[p.id] = 0; });
            scores[loseId] = -totalWin;
        }
        scores[winId] = totalWin;
        currentScores = scores;

        document.getElementById('result').innerHTML = players.map(p => `
            <div class="score-card ${scores[p.id] >= 0 ? 'win-item' : 'lose-item'}">
                <span class="p-name-id-${p.id}"><b>${p.name}</b>${p.id === dealId ? '<span class="dealer-tag">åº„</span>' : ''}</span>
                <span class="score-val">${scores[p.id] > 0 ? '+' : ''}${scores[p.id]}</span>
            </div>
        `).join('');
        renderTotals();
    }

    function renderTotals() {
        const totals = {}; players.forEach(p => totals[p.id] = 0);
        history.forEach(round => {
            Object.keys(round.scores).forEach(id => { if(totals[id] !== undefined) totals[id] += round.scores[id]; });
        });
        document.getElementById('total-panel').innerHTML = players.map(p => `
            <div class="total-item"><div class="p-name-id-${p.id}">${p.name}</div><div style="color:${totals[p.id]>=0?'#ff7675':'#55efc4'}">${totals[p.id]>0?'+':''}${totals[p.id]}</div></div>
        `).join('');
    }

    function recordGame(isZh) {
        const winId = parseInt(document.querySelector('input[name="winner"]:checked').value);
        const dealId = parseInt(document.querySelector('input[name="dealer"]:checked').value);
        const loseId = parseInt(document.querySelector('input[name="loser"]:checked').value);
        const typeText = document.querySelector(`label[for="${document.querySelector('input[name="winType"]:checked').id}"]`).innerText;
        
        let finalScores = {...currentScores};
        if(isZh) { Object.keys(finalScores).forEach(id => finalScores[id] = -finalScores[id]); }

        history.unshift({
            id: Date.now(),
            winName: players.find(p => p.id === winId).name,
            winId: winId,
            dealerId: dealId,
            loserId: loseId,
            type: isZh ? "ç‚¸èƒ¡" : typeText,
            isZh: isZh,
            scores: finalScores,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });
        save(); updateUI(); window.scrollTo(0,0);
    }

    function renderHistory() {
        document.getElementById('history-list').innerHTML = history.map(h => {
            const detail = players.map(p => {
                const s = h.scores[p.id] || 0;
                return `<span style="color:${s>0?'#e74c3c':(s<0?'#27ae60':'#999')}">${p.name.charAt(0)}:${s>0?'+':''}${s}</span>`;
            }).join(' ');
            return `
                <div class="history-item">
                    <div class="history-main">
                        <div>
                            <span class="history-tag ${h.isZh?'zh-tag':''}">${h.isZh?'âš  ç‚¸èƒ¡':h.time}</span>
                            <b style="color:var(--win-text);margin-left:5px">${h.winName}</b>
                            <span style="font-size:11px;color:#999"> Â· ${h.type}</span>
                        </div>
                        <div class="del-btn" onclick="deleteHistory(${h.id})">Ã—</div>
                    </div>
                    <div class="history-detail-bar">${detail}</div>
                </div>`;
        }).join('');
    }

    function copyReport() {
        if (history.length === 0) return alert("æš‚æ— è®°å½•å¯åˆ†äº«");
        
        let stats = {};
        players.forEach(p => stats[p.id] = { total: 0, dPao: 0, maxLz: 0, curLz: 0 });
        
        // æ ¸å¿ƒï¼šæ­£åºéå†å†å²ï¼ˆä»æœ€ä¹…è¿œçš„åˆ°æœ€æ–°ï¼‰ä»¥ç»Ÿè®¡è¿åº„å’Œæ€»åˆ†
        let historyCopy = [...history].reverse();
        let lastDealer = -1;

        historyCopy.forEach(h => {
            players.forEach(p => stats[p.id].total += (h.scores[p.id] || 0));
            if (h.loserId !== -1) stats[h.loserId].dPao++;
            
            // è¿åº„ç»Ÿè®¡é€»è¾‘
            if (h.dealerId === lastDealer) {
                stats[h.dealerId].curLz++;
                stats[h.dealerId].maxLz = Math.max(stats[h.dealerId].maxLz, stats[h.dealerId].curLz);
            } else {
                if (lastDealer !== -1) stats[lastDealer].curLz = 0;
                lastDealer = h.dealerId;
            }
        });

        let sorted = [...players].sort((a,b) => stats[b.id].total - stats[a.id].total);
        let dpWang = [...players].sort((a,b) => stats[b.id].dPao - stats[a.id].dPao)[0];
        let lzWang = [...players].sort((a,b) => stats[b.id].maxLz - stats[a.id].maxLz)[0];

        let text = `ğŸ€„ ã€æµ·ä¼¦éº»å°†ç»“ç®—å•ã€‘\nğŸ“… ${new Date().toLocaleDateString()} (å…±${history.length}å±€)\n-----------------------\nğŸ† ç´¯è®¡æ€»åˆ†æ¦œ\n`;
        sorted.forEach((p, i) => {
            let t = stats[p.id].total;
            text += `${i===0?'ğŸ¥‡':(i===3?'âŒ':'ğŸ”¹')} ${p.name}ï¼š${t>0?'+':''}${t}${i===0?' (èµ¢å®¶)':''}\n`;
        });

        text += `\nğŸ–ï¸ ç‰Œå±€è‹±é›„æ¦œ\nğŸ”« ç‚¹ç‚®ç‹ï¼š${dpWang.name} (${stats[dpWang.id].dPao}æ¬¡)\nğŸ”¥ è¿åº„ç‹ï¼š${lzWang.name} (æœ€é«˜è¿åº„${stats[lzWang.id].maxLz + 1}æŠŠ)\n`;

        text += `\nğŸ“œ å†å²æ˜ç»† (æ­£åºæ’å·)\n`;
        // æ­£åºæ˜¾ç¤ºå‰10å±€ï¼ˆå¦‚æœå±€æ•°å¤šçš„è¯ï¼‰ï¼Œæˆ–è€…æ˜¾ç¤ºæ‰€æœ‰ã€‚è¿™é‡Œå»ºè®®æ­£åºæ’åˆ—ã€‚
        historyCopy.forEach((h, i) => {
            let detail = players.map(p => `${p.name.charAt(0)}:${h.scores[p.id]>0?'+':''}${h.scores[p.id]}`).join(',');
            text += `${i+1}. ${h.winName}(${h.type})\n   [${detail}]\n`;
        });

        text += `-----------------------\nğŸ”— ç»“ç®—å™¨åœ°å€ï¼š\n${window.location.href.split('?')[0]}\nâœ… æ•°æ®å·²æ ¸å¯¹ï¼Œç¥ä¸‹æŠŠç¿»ç›˜ï¼`;

        navigator.clipboard.writeText(text).then(() => alert("âœ… ç»“ç®—å•å·²å¤åˆ¶ï¼å¿«å»å¾®ä¿¡ç²˜è´´å§ã€‚")).catch(() => alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æˆªå›¾åˆ†äº«"));
    }

    function deleteHistory(id) { if(confirm('åˆ é™¤æ­¤æ¡ï¼Ÿ')){ history = history.filter(h => h.id !== id); save(); updateUI(); } }
    function clearHistory() { if(confirm('æ¸…ç©ºè®°å½•ï¼Ÿ')){ history = []; save(); updateUI(); } }
    function refreshLogic(t) { if(t==='winner') updateLoserOptions(); calculate(); }
    function passDealer() {
        const cur = parseInt(document.querySelector('input[name="dealer"]:checked').value);
        const idx = players.findIndex(p => p.id === cur);
        document.getElementById(`dealer${players[(idx+1)%4].id}`).checked = true;
        calculate();
    }
    updateUI();
</script>
</body>
</html>
